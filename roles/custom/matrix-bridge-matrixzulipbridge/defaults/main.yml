# SPDX-FileCopyrightText: 2021 - 2022 Toni Spets
# SPDX-FileCopyrightText: 2022 - 2023 Nikita Chernyi
# SPDX-FileCopyrightText: 2022 - 2025 Slavi Pantaleev
# SPDX-FileCopyrightText: 2022 MDAD project contributors
# SPDX-FileCopyrightText: 2022 Marko Weltzer
# SPDX-FileCopyrightText: 2023 Samuel Meenzen
# SPDX-FileCopyrightText: 2024 Suguru Hirahara
#
# SPDX-License-Identifier: AGPL-3.0-or-later

---
# MatrixZulipBridge is a bouncer-style Matrix IRC bridge
# Project source code URL: https://github.com/hifi/matrixzulipbridge

matrix_matrixzulipbridge_enabled: true

matrix_matrixzulipbridge_scheme: https
matrix_matrixzulipbridge_hostname: "{{ matrix_server_fqn_matrix }}"
matrix_matrixzulipbridge_path_prefix: "/matrixzulipbridge"

# renovate: datasource=docker depName=hif1/matrixzulipbridge
matrix_matrixzulipbridge_version: 1.15.4
matrix_matrixzulipbridge_docker_image: "{{ matrix_matrixzulipbridge_docker_image_registry_prefix }}hif1/matrixzulipbridge:{{ matrix_matrixzulipbridge_version }}"
matrix_matrixzulipbridge_docker_image_registry_prefix: "{{ matrix_matrixzulipbridge_docker_image_registry_prefix_upstream }}"
matrix_matrixzulipbridge_docker_image_registry_prefix_upstream: "{{ matrix_matrixzulipbridge_docker_image_registry_prefix_upstream_default }}"
matrix_matrixzulipbridge_docker_image_registry_prefix_upstream_default: "docker.io/"
matrix_matrixzulipbridge_docker_image_force_pull: "{{ matrix_matrixzulipbridge_docker_image.endswith(':latest') }}"

# Set this to your Matrix ID if you want to enforce the owner, otherwise first _local_ user becomes one
matrix_matrixzulipbridge_owner: ""

# Enabling identd will bind to host port 113/TCP
matrix_matrixzulipbridge_identd_enabled: false

matrix_matrixzulipbridge_base_path: "{{ matrix_base_data_path }}/matrixzulipbridge"

matrix_matrixzulipbridge_container_network: ""

matrix_matrixzulipbridge_container_additional_networks: "{{ matrix_matrixzulipbridge_container_additional_networks_auto + matrix_matrixzulipbridge_container_additional_networks_custom }}"
matrix_matrixzulipbridge_container_additional_networks_auto: []
matrix_matrixzulipbridge_container_additional_networks_custom: []

# Controls how long to wait for the container to stop gracefully before killing it.
# We use a small value here, because this container does not seem to handle the SIGTERM signal.
matrix_matrixzulipbridge_container_stop_grace_time_seconds: 1

# matrix_matrixzulipbridge_container_labels_traefik_enabled controls whether labels to assist a Traefik reverse-proxy will be attached to the container.
# See `../templates/labels.j2` for details.
#
# To inject your own other container labels, see `matrix_matrixzulipbridge_container_labels_additional_labels`.
matrix_matrixzulipbridge_container_labels_traefik_enabled: true
matrix_matrixzulipbridge_container_labels_traefik_docker_network: "{{ matrix_matrixzulipbridge_container_network }}"
matrix_matrixzulipbridge_container_labels_traefik_hostname: "{{ matrix_matrixzulipbridge_hostname }}"
matrix_matrixzulipbridge_container_labels_traefik_path_prefix: "{{ matrix_matrixzulipbridge_path_prefix }}"
matrix_matrixzulipbridge_container_labels_traefik_entrypoints: web-secure
matrix_matrixzulipbridge_container_labels_traefik_tls_certResolver: default  # noqa var-naming

# Controls if the media router is enabled
matrix_matrixzulipbridge_container_labels_traefik_media_enabled: true
matrix_matrixzulipbridge_container_labels_traefik_media_hostname: "{{ matrix_matrixzulipbridge_container_labels_traefik_hostname }}"
# The path prefix must either be `/` or not end with a slash (e.g. `/matrixzulipbridge`).
matrix_matrixzulipbridge_container_labels_traefik_media_path_prefix: "{{ '' if matrix_matrixzulipbridge_container_labels_traefik_path_prefix == '/' else (matrix_matrixzulipbridge_container_labels_traefik_path_prefix) }}/_matrixzulipbridge/media"
matrix_matrixzulipbridge_container_labels_traefik_media_rule: "Host(`{{ matrix_matrixzulipbridge_container_labels_traefik_media_hostname }}`){% if matrix_matrixzulipbridge_container_labels_traefik_media_path_prefix != '/' %} && PathPrefix(`{{ matrix_matrixzulipbridge_container_labels_traefik_media_path_prefix }}`){% endif %}"
matrix_matrixzulipbridge_container_labels_traefik_media_priority: 0
matrix_matrixzulipbridge_container_labels_traefik_media_entrypoints: "{{ matrix_matrixzulipbridge_container_labels_traefik_entrypoints }}"
matrix_matrixzulipbridge_container_labels_traefik_media_tls: "{{ matrix_matrixzulipbridge_container_labels_traefik_media_entrypoints != 'web' }}"
matrix_matrixzulipbridge_container_labels_traefik_media_tls_certResolver: "{{ matrix_matrixzulipbridge_container_labels_traefik_tls_certResolver }}"  # noqa var-naming

# matrix_matrixzulipbridge_container_labels_additional_labels contains a multiline string with additional labels to add to the container label file.
# See `../templates/labels.j2` for details.
#
# Example:
# matrix_matrixzulipbridge_container_labels_additional_labels: |
#   my.label=1
#   another.label="here"
matrix_matrixzulipbridge_container_labels_additional_labels: ''

# A list of extra arguments to pass to the container
matrix_matrixzulipbridge_container_extra_arguments: []

# List of systemd services that service depends on.
matrix_matrixzulipbridge_systemd_required_services_list: "{{ matrix_matrixzulipbridge_systemd_required_services_list_default + matrix_matrixzulipbridge_systemd_required_services_list_auto + matrix_matrixzulipbridge_systemd_required_services_list_custom }}"
matrix_matrixzulipbridge_systemd_required_services_list_default: "{{ [devture_systemd_docker_base_docker_service_name] if devture_systemd_docker_base_docker_service_name else [] }}"
matrix_matrixzulipbridge_systemd_required_services_list_auto: []
matrix_matrixzulipbridge_systemd_required_services_list_custom: []

# List of systemd services that service wants
matrix_matrixzulipbridge_systemd_wanted_services_list: []

matrix_matrixzulipbridge_homeserver_url: ""

matrix_matrixzulipbridge_appservice_token: ''
matrix_matrixzulipbridge_homeserver_token: ''

matrix_matrixzulipbridge_config_media_url: "{{ matrix_matrixzulipbridge_scheme }}://{{ matrix_matrixzulipbridge_hostname }}"
# This matches the hardcoded `DEFAULT_MEDIA_PATH` in MatrixZulipBridge, but uses `matrix_matrixzulipbridge_path_prefix` as the path prefix.
# See: https://github.com/hifi/matrixzulipbridge/blob/7e18a5818f4a8c86cc62e474eee1631d16cb2602/matrixzulipbridge/__main__.py#L66
matrix_matrixzulipbridge_config_media_path: "{{ matrix_matrixzulipbridge_container_labels_traefik_media_path_prefix }}/{server}/{media_id}/{checksum}{filename}"
matrix_matrixzulipbridge_config_media_key: "{{ matrix_matrixzulipbridge_homeserver_token }}"
matrix_matrixzulipbridge_config_displayname: "MatrixZulipBridge"

matrix_matrixzulipbridge_registration_yaml_matrixzulipbridge:
  media_url: "{{ matrix_matrixzulipbridge_config_media_url }}"
  media_path: "{{ matrix_matrixzulipbridge_config_media_path }}"
  media_key: "{{ matrix_matrixzulipbridge_config_media_key }}"
  displayname: "{{ matrix_matrixzulipbridge_config_displayname }}"

# Default registration file consumed by both the homeserver and MatrixZulipBridge.
# Besides registration information, it contains configuration (see the MatrixZulipBridge key).
matrix_matrixzulipbridge_registration_yaml:
  id: matrixzulipbridge
  url: http://matrix-matrixzulipbridge:9898
  as_token: "{{ matrix_matrixzulipbridge_appservice_token }}"
  hs_token: "{{ matrix_matrixzulipbridge_homeserver_token }}"
  rate_limited: false
  sender_localpart: matrixzulipbridge
  namespaces:
    users:
      - regex: '@hbirc_.*'
        exclusive: true
    aliases: []
    rooms: []
  matrixzulipbridge: "{{ matrix_matrixzulipbridge_registration_yaml_matrixzulipbridge }}"

matrix_matrixzulipbridge_registration: "{{ matrix_matrixzulipbridge_registration_yaml | from_yaml }}"
